import { Ionicons } from "@expo/vector-icons";
import * as ImagePicker from "expo-image-picker";
import { LinearGradient } from "expo-linear-gradient";
import React, { useEffect, useRef, useState } from "react";
import {
    ActivityIndicator,
    Animated,
    Dimensions,
    Image,
    KeyboardAvoidingView,
    Modal,
    Platform,
    ScrollView,
    StatusBar,
    StyleSheet,
    Text,
    TextInput,
    TouchableOpacity,
    View,
} from "react-native";
import { SafeAreaView } from "react-native-safe-area-context";
import * as addressService from "../services/addressService";
import { API_URL as GLOBAL_API_URL } from "../services/apiConfig";
import * as leadSourceService from "../services/leadSourceService";
import notificationService from "../services/notificationService";
import { getImageUrl } from "../utils/imageHelper";

const API_URL = `${GLOBAL_API_URL}/enquiries`;
const { width, height } = Dimensions.get("window");

// Modern 2026 Color Palette
const COLORS = {
    primary: "#6366f1",
    primaryDark: "#4f46e5",
    secondary: "#8b5cf6",
    success: "#10b981",
    warning: "#f59e0b",
    danger: "#ef4444",
    dark: "#1e293b",
    gray: {
        50: "#f8fafc",
        100: "#f1f5f9",
        200: "#e2e8f0",
        300: "#cbd5e1",
        400: "#94a3b8",
        500: "#64748b",
        600: "#475569",
        700: "#334155",
        800: "#1e293b",
        900: "#0f172a",
    },
    white: "#ffffff",
    gradient: ["#6366f1", "#8b5cf6"],
};

export default function AddEnquiryScreen({ route, navigation }) {
    const editingEnquiry = route?.params?.enquiry; // Get enquiry from navigation params
    const isEditMode = !!editingEnquiry; // Determine if we're in edit mode

    const [form, setForm] = useState({
        enqType: "Normal",
        source: "",
        name: "",
        mobile: "",
        address: "",
        product: "",
        cost: "",
        image: null,
    });
    const [loading, setLoading] = useState(false);
    const [showAdvanced, setShowAdvanced] = useState(false);
    const [errors, setErrors] = useState({});
    const [leadSources, setLeadSources] = useState([]);
    const [loadingSources, setLoadingSources] = useState(false);
    const [showSourceModal, setShowSourceModal] = useState(false);
    const [addressPredictions, setAddressPredictions] = useState([]);
    const [addressLoading, setAddressLoading] = useState(false);
    const [showAddressDropdown, setShowAddressDropdown] = useState(false);

    // Toast animation state
    const [toastMessage, setToastMessage] = useState("");
    const [toastType, setToastType] = useState("success"); // "success" | "error"
    const [toastVisible, setToastVisible] = useState(false);
    const toastAnimValue = useRef(new Animated.Value(0)).current;
    const toastTimeoutRef = useRef(null);

    // Animation
    const fadeAnim = React.useRef(new Animated.Value(0)).current;

    // Ensure notifications are initialized on mount
    useEffect(() => {
        notificationService.initializeNotifications();
    }, []);

    useEffect(() => {
        // Entrance animation
        Animated.timing(fadeAnim, {
            toValue: 1,
            duration: 600,
            useNativeDriver: true,
        }).start();

        // Fetch lead sources
        const fetchLeadSources = async () => {
            try {
                setLoadingSources(true);
                const groups = await leadSourceService.getAllLeadSources();
                const sources = [];
                groups?.forEach((group) => {
                    group.sources?.forEach((source) => {
                        sources.push({
                            id: source._id,
                            name: source.name,
                            group: group.name,
                        });
                    });
                });
                setLeadSources(sources);
            } catch (error) {
                console.error("Error fetching lead sources:", error);
            } finally {
                setLoadingSources(false);
            }
        };
        fetchLeadSources();

        // Pre-fill form if editing
        if (isEditMode && editingEnquiry) {
            setForm({
                enqType: editingEnquiry.enqType || "Normal",
                source: editingEnquiry.source || "",
                name: editingEnquiry.name || "",
                mobile: editingEnquiry.mobile || "",
                address: editingEnquiry.address || "",
                product: editingEnquiry.product || "",
                cost: editingEnquiry.cost?.toString() || "",
                image: editingEnquiry.image || null,
            });
            // Show advanced section if there's address data
            if (editingEnquiry.address) {
                setShowAdvanced(true);
            }
        }
    }, [isEditMode, editingEnquiry]);

    const updateField = (field, value) => {
        setForm((prev) => ({ ...prev, [field]: value }));
        if (errors[field]) {
            setErrors((prev) => ({ ...prev, [field]: null }));
        }
    };

    const pickImage = async () => {
        // No request permissions needed for launching image library in Expo SDK 53+
        let result = await ImagePicker.launchImageLibraryAsync({
            mediaTypes: ImagePicker.MediaTypeOptions.Images,
            allowsEditing: true,
            aspect: [1, 1],
            quality: 0.5,
            base64: true, // Get base64 data
        });

        if (!result.canceled) {
            const asset = result.assets[0];
            // Store as base64 data URL for database storage
            const base64Image = `data:image/jpeg;base64,${asset.base64}`;
            updateField("image", base64Image);
        }
    };

    // Handle address input change with debouncing
    const addressTimeoutRef = React.useRef(null);
    const handleAddressChange = (text) => {
        updateField("address", text);

        // Clear previous timeout
        if (addressTimeoutRef.current) {
            clearTimeout(addressTimeoutRef.current);
        }

        if (text.trim().length >= 3) {
            setAddressLoading(true);
            addressTimeoutRef.current = setTimeout(async () => {
                try {
                    const predictions =
                        await addressService.getAddressPredictions(text);
                    setAddressPredictions(predictions);
                    setShowAddressDropdown(true);
                } catch (error) {
                    console.error("Error fetching predictions:", error);
                } finally {
                    setAddressLoading(false);
                }
            }, 300);
        } else {
            setAddressPredictions([]);
            setShowAddressDropdown(false);
        }
    };

    // Handle address selection from dropdown
    const handleAddressSelect = async (prediction) => {
        setShowAddressDropdown(false);
        setAddressLoading(true);

        try {
            const details = await addressService.getPlaceDetails(
                prediction.placeId,
            );
            if (details) {
                updateField("address", details.address);
            } else {
                updateField("address", prediction.fullAddress);
            }
        } catch (error) {
            console.error("Error selecting address:", error);
            updateField("address", prediction.fullAddress);
        } finally {
            setAddressLoading(false);
        }
    };

    const validateForm = () => {
        const newErrors = {};

        // In edit mode, only validate fields that are being changed (non-empty)
        // In create mode, validate all required fields
        if (!isEditMode) {
            // Create mode: strict validation
            if (!form.name?.trim()) newErrors.name = "Name is required";
            if (!form.mobile?.trim()) newErrors.mobile = "Mobile is required";
            if (!form.product?.trim()) newErrors.product = "Product is required";
        } else {
            // Edit mode: only validate if field has value (optional validation)
            // This allows editing specific fields without requiring all fields
            if (form.name && !form.name.trim()) {
                newErrors.name = "Name cannot be empty";
            }
            if (form.mobile && !form.mobile.trim()) {
                newErrors.mobile = "Mobile cannot be empty";
            }
            if (form.product && !form.product.trim()) {
                newErrors.product = "Product cannot be empty";
            }
        }

        // Validate mobile format if provided
        if (form.mobile?.trim() && form.mobile.trim().length !== 10) {
            newErrors.mobile = "Mobile must be 10 digits";
        }

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    // Show animated toast popup
    const showToast = (message, type = "success", autoDismiss = true) => {
        // Clear any existing timeout
        if (toastTimeoutRef.current) {
            clearTimeout(toastTimeoutRef.current);
        }

        setToastMessage(message);
        setToastType(type);
        setToastVisible(true);

        // Animate in
        Animated.spring(toastAnimValue, {
            toValue: 1,
            useNativeDriver: true,
            tension: 50,
            friction: 10,
        }).start();

        // Auto-dismiss if requested
        if (autoDismiss) {
            toastTimeoutRef.current = setTimeout(() => {
                Animated.timing(toastAnimValue, {
                    toValue: 0,
                    duration: 300,
                    useNativeDriver: true,
                }).start(() => {
                    setToastVisible(false);
                });
            }, 2500);
        }
    };

    const handleSubmit = async () => {
        if (!validateForm()) return;

        setLoading(true);
        try {
            const url = isEditMode
                ? `${API_URL}/${editingEnquiry._id}`
                : API_URL;
            const method = isEditMode ? "PUT" : "POST";

            let response;

            // Always use JSON (images are now base64 encoded)
            response = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(form),
            });

            const data = await response.json();
            if (response.ok) {
                // Success: show toast and notification
                const successMessage = isEditMode
                    ? "✅ Enquiry updated successfully!"
                    : "✅ Enquiry created successfully!";
                showToast(successMessage, "success", true);

                // Show success notification with enquiry details
                if (!isEditMode) {
                    await notificationService.showEnquirySuccessNotification({
                        name: form.name,
                        source: form.source,
                        product: form.product,
                    });
                }

                // Reset form and close after showing success toast
                setTimeout(() => {
                    if (!isEditMode) {
                        setForm({
                            enqType: "Normal",
                            source: "",
                            name: "",
                            mobile: "",
                            address: "",
                            product: "",
                            cost: "",
                            image: null,
                        });
                        setShowAdvanced(false);
                        setAddressPredictions([]);
                        setShowAddressDropdown(false);
                        setAddressLoading(false);
                    }

                    // Call the callback and close form
                    route.params?.onEnquirySaved?.(data);

                    // Close the form after 1.2 seconds total (0.3s + 0.9s)
                    setTimeout(() => {
                        navigation.goBack();
                    }, 900);
                }, 300);
            } else {
                // Show error notification
                const errorMessage =
                    data.message ||
                    (isEditMode
                        ? "Failed to update enquiry"
                        : "Failed to create enquiry");
                await notificationService.showEnquiryErrorNotification(
                    errorMessage,
                );
                showToast(errorMessage, "error");
            }
        } catch (error) {
            // Show error notification for network errors
            await notificationService.showEnquiryErrorNotification(
                error.message || "Network error. Please try again.",
            );
            showToast(
                error.message || "Network error. Please try again.",
                "error",
            );
        } finally {
            setLoading(false);
        }
    };

    // --- RENDER HELPERS ---
    const renderInput = (
        label,
        value,
        onChange,
        placeholder,
        icon,
        keyboardType = "default",
        error,
        autoCapitalize = "sentences",
    ) => (
        <View style={styles.inputWrapper}>
            <Text style={styles.inputLabel}>{label}</Text>
            <View
                style={[
                    styles.inputContainer,
                    error && styles.inputErrorBorder,
                    { borderColor: error ? COLORS.danger : COLORS.gray[200] },
                ]}>
                <View style={styles.inputIconBox}>
                    <Ionicons name={icon} size={20} color={COLORS.gray[400]} />
                </View>
                <TextInput
                    style={styles.inputField}
                    value={value}
                    onChangeText={onChange}
                    placeholder={placeholder}
                    placeholderTextColor={COLORS.gray[400]}
                    keyboardType={keyboardType}
                    autoCapitalize={autoCapitalize}
                />
            </View>
            {error && <Text style={styles.errorText}>{error}</Text>}
        </View>
    );

    return (
        <SafeAreaView style={styles.container}>
            <StatusBar
                barStyle="light-content"
                backgroundColor={COLORS.primary}
            />

            {/* Header */}
            <LinearGradient
                colors={COLORS.gradient}
                start={{ x: 0, y: 0 }}
                end={{ x: 1, y: 1 }}
                style={styles.header}>
                <View style={styles.headerTop}>
                    <TouchableOpacity
                        style={styles.backButton}
                        onPress={() => navigation.goBack()}>
                        <Ionicons
                            name="arrow-back"
                            size={24}
                            color={COLORS.white}
                        />
                    </TouchableOpacity>
                    <Text style={styles.headerTitle}>
                        {isEditMode ? "Edit Enquiry" : "New Enquiry"}
                    </Text>
                    <TouchableOpacity style={styles.helpButton}>
                        <Ionicons
                            name="help-circle-outline"
                            size={24}
                            color={COLORS.white}
                        />
                    </TouchableOpacity>
                </View>
                <Text style={styles.headerSubtitle}>
                    {isEditMode
                        ? "Update the enquiry details below"
                        : "Fill in the details below to create a new lead"}
                </Text>
            </LinearGradient>

            {/* Main Content */}
            <KeyboardAvoidingView
                style={styles.keyboardContainer}
                behavior={Platform.OS === "ios" ? "padding" : "height"}>
                <ScrollView
                    style={styles.scrollView}
                    contentContainerStyle={styles.scrollContent}
                    showsVerticalScrollIndicator={false}
                    keyboardShouldPersistTaps="always">
                    <Animated.View
                        style={[styles.contentContainer, { opacity: fadeAnim }]}>

                        {/* 1. Categorization Card */}
                        <View style={styles.card}>
                            <View style={styles.cardHeader}>
                                <Ionicons name="pricetags-outline" size={20} color={COLORS.primary} />
                                <Text style={styles.cardTitle}>Categorization</Text>
                            </View>

                            <View style={styles.inputWrapper}>
                                <Text style={styles.inputLabel}>Priority Level</Text>
                                <View style={styles.priorityGrid}>
                                    {["High", "Medium", "Normal"].map((priority) => {
                                        const isActive = form.enqType === priority;
                                        let activeColor = COLORS.success;
                                        if (priority === "High") activeColor = COLORS.danger;
                                        if (priority === "Medium") activeColor = COLORS.warning;
                                        if (priority === "Normal") activeColor = COLORS.primary;

                                        return (
                                            <TouchableOpacity
                                                key={priority}
                                                style={[
                                                    styles.priorityCard,
                                                    isActive && { backgroundColor: activeColor + "15", borderColor: activeColor }
                                                ]}
                                                onPress={() => updateField("enqType", priority)}>
                                                <View style={[
                                                    styles.priorityDot,
                                                    { backgroundColor: isActive ? activeColor : COLORS.gray[300] }
                                                ]} />
                                                <Text style={[
                                                    styles.priorityText,
                                                    isActive && { color: activeColor, fontWeight: "700" }
                                                ]}>
                                                    {priority}
                                                </Text>
                                            </TouchableOpacity>
                                        );
                                    })}
                                </View>
                            </View>

                            <View style={styles.inputWrapper}>
                                <Text style={styles.inputLabel}>Lead Source</Text>
                                <TouchableOpacity
                                    style={styles.dropdownButton}
                                    onPress={() => setShowSourceModal(true)}>
                                    <View style={styles.dropdownLeft}>
                                        <View style={styles.inputIconBox}>
                                            <Ionicons name="share-social-outline" size={20} color={COLORS.gray[400]} />
                                        </View>
                                        <Text style={form.source ? styles.dropdownText : styles.dropdownPlaceholder}>
                                            {form.source || "Select Source "}
                                        </Text>
                                    </View>
                                    <Ionicons name="chevron-down" size={20} color={COLORS.gray[400]} />
                                </TouchableOpacity>
                            </View>
                        </View>

                        {/* 2. Customer Details Card */}
                        <View style={styles.card}>
                            <View style={styles.cardHeader}>
                                <Ionicons name="person-outline" size={20} color={COLORS.primary} />
                                <Text style={styles.cardTitle}>Customer Details</Text>
                            </View>



                            {renderInput(
                                "Full Name *",
                                form.name,
                                (text) => updateField("name", text),
                                "Enter customer full name",
                                "person-outline",
                                "default",
                                errors.name
                            )}

                            {renderInput(
                                "Mobile Number *",
                                form.mobile,
                                (text) => updateField("mobile", text),
                                "Enter 10-digit number",
                                "call-outline",
                                "phone-pad",
                                errors.mobile
                            )}
                        </View>

                        {/* 3. Requirement Card */}
                        <View style={styles.card}>
                            <View style={styles.cardHeader}>
                                <Ionicons name="cart-outline" size={20} color={COLORS.primary} />
                                <Text style={styles.cardTitle}>Requirement</Text>
                            </View>

                            {renderInput(
                                "Product / Service *",
                                form.product,
                                (text) => updateField("product", text),
                                "What are they interested in?",
                                "cube-outline",
                                "default",
                                errors.product
                            )}

                            {renderInput(
                                "Estimated Value (₹)",
                                form.cost,
                                (text) => updateField("cost", text),
                                "0.00",
                                "cash-outline",
                                "decimal-pad"
                            )}
                        </View>

                        {/* 4. Location (Toggle) */}
                        <View style={styles.card}>
                            <TouchableOpacity
                                style={styles.accordionHeader}
                                onPress={() => setShowAdvanced(!showAdvanced)}>
                                <View style={styles.accordionLeft}>
                                    <View style={[styles.inputIconBox, { backgroundColor: COLORS.primary + "10" }]}>
                                        <Ionicons name="location-outline" size={20} color={COLORS.primary} />
                                    </View>
                                    <Text style={styles.cardTitle}>Location & Address</Text>
                                </View>
                                <Ionicons name={showAdvanced ? "chevron-up" : "chevron-down"} size={20} color={COLORS.gray[400]} />
                            </TouchableOpacity>

                            {showAdvanced && (
                                <View style={styles.accordionContent}>
                                    <View style={styles.inputWrapper}>
                                        <Text style={styles.inputLabel}>Full Address</Text>
                                        <View style={[styles.inputContainer, { alignItems: 'flex-start', paddingVertical: 12, height: 'auto', minHeight: 100 }]}>
                                            <View style={[styles.inputIconBox, { marginTop: 0 }]}>
                                                <Ionicons name="map-outline" size={20} color={COLORS.gray[400]} />
                                            </View>
                                            <View style={{ flex: 1 }}>
                                                <TextInput
                                                    style={[styles.inputField, { height: '100%', textAlignVertical: 'top', paddingTop: 8 }]}
                                                    value={form.address}
                                                    onChangeText={handleAddressChange}
                                                    placeholder="Enter full address or city..."
                                                    placeholderTextColor={COLORS.gray[400]}
                                                    multiline
                                                />
                                            </View>
                                        </View>

                                        {/* Address Predictions */}
                                        {showAddressDropdown && addressPredictions.length > 0 && (
                                            <View style={styles.predictionsContainer}>
                                                {addressLoading && (
                                                    <ActivityIndicator size="small" color={COLORS.primary} style={{ margin: 10 }} />
                                                )}
                                                {addressPredictions.map((prediction, index) => (
                                                    <TouchableOpacity
                                                        key={prediction.placeId || index}
                                                        style={styles.predictionItem}
                                                        onPress={() => handleAddressSelect(prediction)}>
                                                        <Ionicons name="location-sharp" size={16} color={COLORS.gray[400]} style={{ marginTop: 2 }} />
                                                        <View style={{ marginLeft: 10, flex: 1 }}>
                                                            <Text style={styles.predictionMain}>{prediction.mainText}</Text>
                                                            <Text style={styles.predictionSub}>{prediction.secondaryText}</Text>
                                                        </View>
                                                    </TouchableOpacity>
                                                ))}
                                            </View>
                                        )}
                                        <View style={styles.imageUploadContainer}>
                                            <TouchableOpacity onPress={pickImage} style={styles.imagePicker}>
                                                {form.image ? (
                                                    <Image source={{ uri: getImageUrl(form.image) }} style={styles.uploadedImage} />
                                                ) : (
                                                    <View style={styles.imagePlaceholder}>
                                                        <Ionicons name="camera-outline" size={32} color={COLORS.primary} />
                                                        <Text style={styles.uploadText}>Add Photo</Text>
                                                    </View>
                                                )}
                                                <View style={styles.editIconBadge}>
                                                    <Ionicons name="pencil" size={12} color={COLORS.white} />
                                                </View>
                                            </TouchableOpacity>
                                        </View>
                                    </View>
                                </View>
                            )}


                        </View>

                        {/* Image Upload for Customer */}


                        {/* Spacer for bottom button */}
                        <View style={{ height: 100 }} />

                    </Animated.View>
                </ScrollView>
            </KeyboardAvoidingView>

            {/* Footer Button */}
            <View style={styles.footerContainer}>
                <TouchableOpacity
                    style={[styles.submitButton, loading && styles.disabledButton]}
                    onPress={handleSubmit}
                    activeOpacity={0.8}
                    disabled={loading}>
                    <LinearGradient
                        colors={COLORS.gradient}
                        start={{ x: 0, y: 0 }}
                        end={{ x: 1, y: 0 }}
                        style={styles.gradientButton}>
                        {loading ? (
                            <ActivityIndicator color={COLORS.white} />
                        ) : (
                            <>
                                <Text style={styles.submitText}>Create Enquiry</Text>
                                <View style={styles.iconCircle}>
                                    <Ionicons name="arrow-forward" size={18} color={COLORS.primary} />
                                </View>
                            </>
                        )}
                    </LinearGradient>
                </TouchableOpacity>
            </View>

            {/* Source Selection Modal */}
            <Modal
                visible={showSourceModal}
                transparent
                animationType="fade"
                onRequestClose={() => setShowSourceModal(false)}>
                <View style={styles.modalOverlay}>
                    <View style={styles.modalContent}>
                        <View style={styles.modalHeader}>
                            <Text style={styles.modalTitle}>Select Lead Source</Text>
                            <TouchableOpacity onPress={() => setShowSourceModal(false)} style={styles.closeBtn}>
                                <Ionicons name="close" size={24} color={COLORS.gray[600]} />
                            </TouchableOpacity>
                        </View>

                        {loadingSources ? (
                            <View style={styles.centerBox}>
                                <ActivityIndicator size="large" color={COLORS.primary} />
                                <Text style={styles.loadingText}>Loading sources...</Text>
                            </View>
                        ) : (
                            <ScrollView style={styles.modalScroll}>
                                <View style={styles.modalGrid}>
                                    {leadSources.map((source) => (
                                        <TouchableOpacity
                                            key={source.id}
                                            style={[
                                                styles.sourceCard,
                                                form.source === source.name && styles.sourceCardActive
                                            ]}
                                            onPress={() => {
                                                updateField("source", source.name);
                                                setShowSourceModal(false);
                                            }}>
                                            <View style={[
                                                styles.sourceIconBox,
                                                form.source === source.name ? { backgroundColor: COLORS.white } : { backgroundColor: COLORS.gray[100] }
                                            ]}>
                                                <Ionicons
                                                    name={form.source === source.name ? "checkmark-circle" : "ellipse-outline"}
                                                    size={24}
                                                    color={form.source === source.name ? COLORS.primary : COLORS.gray[400]}
                                                />
                                            </View>
                                            <Text style={[
                                                styles.sourceName,
                                                form.source === source.name && { color: COLORS.white, fontWeight: "700" }
                                            ]}>{source.name}</Text>
                                            {source.group && (
                                                <Text style={[
                                                    styles.sourceGroup,
                                                    form.source === source.name && { color: "rgba(255,255,255,0.8)" }
                                                ]}>{source.group}</Text>
                                            )}
                                        </TouchableOpacity>
                                    ))}
                                </View>
                            </ScrollView>
                        )}
                    </View>
                </View>
            </Modal>

            {/* Animated Toast Popup */}
            {toastVisible && (
                <Animated.View
                    style={[
                        styles.toastContainer,
                        {
                            opacity: toastAnimValue,
                            transform: [{
                                translateY: toastAnimValue.interpolate({
                                    inputRange: [0, 1],
                                    outputRange: [-20, 0],
                                }),
                            }],
                        },
                    ]}>
                    <View style={[styles.toastContent, { backgroundColor: toastType === "success" ? COLORS.success : COLORS.danger }]}>
                        <Ionicons name={toastType === "success" ? "checkmark-circle" : "alert-circle"} size={24} color={COLORS.white} />
                        <Text style={styles.toastText}>{toastMessage}</Text>
                    </View>
                </Animated.View>
            )}
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: "#F1F5F9", // Slate 100
    },
    header: {
        paddingTop: Platform.OS === "ios" ? 50 : 30 + StatusBar.currentHeight,
        paddingBottom: 25,
        paddingHorizontal: 24,
        borderBottomLeftRadius: 30,
        borderBottomRightRadius: 30,
        elevation: 8,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 8 },
        shadowOpacity: 0.25,
        shadowRadius: 16,
    },
    headerTop: {
        flexDirection: "row",
        alignItems: "center",
        justifyContent: "space-between",
        marginBottom: 8,
    },
    backButton: {
        width: 40,
        height: 40,
        borderRadius: 20,
        backgroundColor: "rgba(255,255,255,0.2)",
        alignItems: "center",
        justifyContent: "center",
        borderWidth: 1,
        borderColor: "rgba(255,255,255,0.3)",
    },
    helpButton: {
        width: 40,
        height: 40,
        alignItems: "center",
        justifyContent: "center",
    },
    headerTitle: {
        fontSize: 22,
        fontWeight: "700",
        color: COLORS.white,
        letterSpacing: 0.5,
    },
    headerSubtitle: {
        fontSize: 14,
        color: "rgba(255,255,255,0.8)",
        textAlign: "center",
        marginTop: 5,
    },
    keyboardContainer: {
        flex: 1,
    },
    scrollView: {
        flex: 1,
    },
    scrollContent: {
        paddingTop: 20,
        paddingHorizontal: 20,
        paddingBottom: 120, // space for footer
    },
    contentContainer: {
        gap: 20,
    },
    card: {
        backgroundColor: COLORS.white,
        borderRadius: 20,
        padding: 20,
        shadowColor: "#64748B",
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.08,
        shadowRadius: 12,
        elevation: 4,
    },
    cardHeader: {
        flexDirection: "row",
        alignItems: "center",
        marginBottom: 16,
        gap: 10,
    },
    cardTitle: {
        fontSize: 16,
        fontWeight: "700",
        color: COLORS.gray[800],
    },
    inputWrapper: {
        marginBottom: 16,
    },
    inputLabel: {
        fontSize: 13,
        fontWeight: "600",
        color: COLORS.gray[600],
        marginBottom: 8,
        marginLeft: 4,
    },
    inputContainer: {
        flexDirection: "row",
        alignItems: "center",
        backgroundColor: COLORS.gray[50], // Very light gray bg
        borderWidth: 1.5,
        borderColor: COLORS.gray[200],
        borderRadius: 14,
        paddingHorizontal: 12,
        height: 54, // Taller inputs
    },
    inputErrorBorder: {
        borderColor: COLORS.danger,
        backgroundColor: "#FEF2F2",
    },
    inputIconBox: {
        width: 36,
        height: 36,
        borderRadius: 10,
        backgroundColor: COLORS.white,
        alignItems: "center",
        justifyContent: "center",
        marginRight: 12,
        borderWidth: 1,
        borderColor: COLORS.gray[100],
    },
    inputField: {
        flex: 1,
        fontSize: 16,
        color: COLORS.gray[800],
        fontWeight: "500",
    },
    errorText: {
        fontSize: 12,
        color: COLORS.danger,
        marginTop: 6,
        marginLeft: 4,
        fontWeight: "500",
    },
    // Priority custom styling
    priorityGrid: {
        flexDirection: "row",
        gap: 10,
    },
    priorityCard: {
        flex: 1,
        paddingVertical: 12,
        borderRadius: 12,
        backgroundColor: COLORS.white,
        borderWidth: 1.5,
        borderColor: COLORS.gray[200],
        alignItems: "center",
        justifyContent: "center",
        gap: 6,
    },
    priorityDot: {
        width: 8,
        height: 8,
        borderRadius: 4,
    },
    priorityText: {
        fontSize: 12,
        fontWeight: "600",
        color: COLORS.gray[500],
    },
    // Dropdown
    dropdownButton: {
        flexDirection: "row",
        alignItems: "center",
        justifyContent: "space-between",
        backgroundColor: COLORS.white,
        borderWidth: 1.5,
        borderColor: COLORS.gray[200],
        borderRadius: 14,
        padding: 12,
        height: 60,
    },
    dropdownLeft: {
        flexDirection: "row",
        alignItems: "center",
        flex: 1,
    },
    dropdownText: {
        fontSize: 16,
        fontWeight: "600",
        color: COLORS.gray[800],
    },
    dropdownPlaceholder: {
        fontSize: 15,
        color: COLORS.gray[400],
    },
    // Accordion
    accordionHeader: {
        flexDirection: "row",
        alignItems: "center",
        justifyContent: "space-between",
    },
    accordionLeft: {
        flexDirection: "row",
        alignItems: "center",
        gap: 12,
    },
    accordionContent: {
        marginTop: 20,
        paddingTop: 20,
        borderTopWidth: 1,
        borderTopColor: COLORS.gray[100],
    },
    predictionsContainer: {
        backgroundColor: COLORS.white,
        borderRadius: 12,
        marginTop: 10,
        borderWidth: 1,
        borderColor: COLORS.gray[200],
        overflow: "hidden",
    },
    predictionItem: {
        flexDirection: 'row',
        padding: 14,
        borderBottomWidth: 1,
        borderBottomColor: COLORS.gray[50],
        alignItems: "flex-start",
    },
    predictionMain: {
        fontSize: 14,
        fontWeight: "600",
        color: COLORS.gray[800],
    },
    predictionSub: {
        fontSize: 12,
        color: COLORS.gray[500],
        marginTop: 2,
    },
    // Footer / Submit
    footerContainer: {
        position: "absolute",
        bottom: 0,
        left: 0,
        right: 0,
        backgroundColor: COLORS.white,
        paddingHorizontal: 24,
        paddingTop: 20,
        paddingBottom: Platform.OS === 'ios' ? 34 : 24,
        borderTopLeftRadius: 24,
        borderTopRightRadius: 24,
        shadowColor: "#000",
        shadowOffset: { width: 0, height: -4 },
        shadowOpacity: 0.05,
        shadowRadius: 10,
        elevation: 20,
    },
    submitButton: {
        borderRadius: 18,
        overflow: "hidden",
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 8 },
        shadowOpacity: 0.35,
        shadowRadius: 16,
        elevation: 10,
    },
    disabledButton: {
        opacity: 0.7,
    },
    gradientButton: {
        paddingVertical: 18,
        flexDirection: "row",
        alignItems: "center",
        justifyContent: "center",
        gap: 10,
    },
    submitText: {
        fontSize: 18,
        fontWeight: "700",
        color: COLORS.white,
        letterSpacing: 0.5,
    },
    iconCircle: {
        width: 28,
        height: 28,
        borderRadius: 14,
        backgroundColor: COLORS.white,
        alignItems: "center",
        justifyContent: "center",
    },
    // Modal
    modalOverlay: {
        flex: 1,
        backgroundColor: "rgba(15, 23, 42, 0.6)", // Blur effect background
        justifyContent: "flex-end",
    },
    modalContent: {
        backgroundColor: COLORS.gray[50],
        borderTopLeftRadius: 30,
        borderTopRightRadius: 30,
        height: "75%",
        shadowColor: "#000",
        shadowOffset: { width: 0, height: -4 },
        shadowOpacity: 0.25,
        shadowRadius: 20,
        elevation: 25,
        overflow: "hidden",
    },
    modalHeader: {
        flexDirection: "row",
        justifyContent: "space-between",
        alignItems: "center",
        padding: 24,
        backgroundColor: COLORS.white,
        borderBottomWidth: 1,
        borderBottomColor: COLORS.gray[200],
    },
    modalTitle: {
        fontSize: 20,
        fontWeight: "700",
        color: COLORS.gray[900],
    },
    closeBtn: {
        padding: 4,
        backgroundColor: COLORS.gray[100],
        borderRadius: 20,
    },
    modalScroll: {
        flex: 1,
        padding: 20,
    },
    modalGrid: {
        flexDirection: "row",
        flexWrap: "wrap",
        gap: 12,
        paddingBottom: 40,
    },
    sourceCard: {
        width: "48%",
        backgroundColor: COLORS.white,
        borderRadius: 16,
        padding: 16,
        borderWidth: 1,
        borderColor: COLORS.gray[200],
        gap: 10,
        shadowColor: "#000",
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.05,
        shadowRadius: 4,
        elevation: 2,
    },
    sourceCardActive: {
        backgroundColor: COLORS.primary,
        borderColor: COLORS.primary,
    },
    sourceIconBox: {
        width: 38,
        height: 38,
        borderRadius: 19,
        alignItems: "center",
        justifyContent: "center",
    },
    sourceName: {
        fontSize: 14,
        fontWeight: "700",
        color: COLORS.gray[800],
    },
    sourceGroup: {
        fontSize: 12,
        color: COLORS.gray[500],
    },
    centerBox: {
        flex: 1,
        alignItems: "center",
        justifyContent: "center",
    },
    loadingText: {
        marginTop: 12,
        color: COLORS.gray[500],
        fontSize: 14,
    },
    // Toast
    toastContainer: {
        position: "absolute",
        top: Platform.OS === "ios" ? 50 : 30,
        alignSelf: 'center',
        zIndex: 9999,
        width: '90%',
    },
    toastContent: {
        flexDirection: "row",
        alignItems: "center",
        paddingVertical: 14,
        paddingHorizontal: 20,
        borderRadius: 16,
        gap: 12,
        shadowColor: "#000",
        shadowOffset: { width: 0, height: 8 },
        shadowOpacity: 0.2,
        shadowRadius: 12,
        elevation: 8,
    },
    toastText: {
        color: COLORS.white,
        fontSize: 15,
        fontWeight: "600",
        flex: 1,
    },
    // Image Upload Styles
    imageUploadContainer: {
        alignItems: "center",
        marginTop: 20,
    },
    imagePicker: {
        width: 100,
        height: 100,
        borderRadius: 50,
        backgroundColor: COLORS.gray[100],
        borderWidth: 2,
        borderColor: COLORS.primary,
        borderStyle: "dashed",
        justifyContent: "center",
        alignItems: "center",
        overflow: "hidden",
        position: "relative",
    },
    uploadedImage: {
        width: "100%",
        height: "100%",
        borderRadius: 50,
    },
    imagePlaceholder: {
        alignItems: "center",
        justifyContent: "center",
    },
    uploadText: {
        fontSize: 10,
        color: COLORS.primary,
        marginTop: 4,
        fontWeight: "600",
    },
    editIconBadge: {
        position: "absolute",
        bottom: 0,
        right: 0,
        backgroundColor: COLORS.primary,
        width: 28,
        height: 28,
        borderRadius: 14,
        alignItems: "center",
        justifyContent: "center",
        borderWidth: 2,
        borderColor: COLORS.white,
    },
});
